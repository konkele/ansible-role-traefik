docker_stacks_defaults:
  - name: traefik
    mode: swarm
    state: present

    allow_prune: true

    directories:
      base:
        path: /opt/stacks
      stack: {}
      config: {}
      data: {}
      secrets:
        owner: root
        group: root
        mode: "0700"

    directories_defaults:
      owner: root
      group: docker
      mode: "0755"

    label_secret_hash: docker.secrets.hash

    services:
      controller:
        image: traefik:v3.6
        command:
          # --- API ---
          - "--api.dashboard=true"
          - "--api.insecure=false"

          # --- Providers ---
          - "--providers.swarm=true"
          - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
          - "--providers.swarm.watch=true"
          - "--providers.swarm.exposedByDefault=false"
          - "--providers.swarm.network=proxy"

          - "--providers.file.watch=true"
          - "--providers.file.directory=/etc/traefik/config"

          # --- EntryPoints ---
          # web (80)
          - "--entrypoints.web.address=:80"
          - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
          - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

          - "--entrypoints.web.transport.respondingtimeouts.idletimeout=120s"
          - "--entrypoints.web.transport.respondingtimeouts.readtimeout=60s"
          - "--entrypoints.web.transport.respondingtimeouts.writetimeout=60s"

          # websecure (443)
          - "--entrypoints.websecure.address=:443"
          - "--entrypoints.websecure.asdefault=true"

          - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
          - "--entrypoints.websecure.http.tls.domains[0].main=${TLS_DOMAIN_MAIN}"
          - "--entrypoints.websecure.http.tls.domains[0].sans=${TLS_DOMAIN_SANS}"

          - "--entrypoints.websecure.transport.respondingtimeouts.idletimeout=120s"
          - "--entrypoints.websecure.transport.respondingtimeouts.readtimeout=60s"
          - "--entrypoints.websecure.transport.respondingtimeouts.writetimeout=60s"

          # mqttsecure (8883)
          - "--entrypoints.mqttsecure.address=:8883"

          # --- Certificates (ACME / Let's Encrypt) ---
          - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
          - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
          - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-v02.api.letsencrypt.org/directory"

          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53"
          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=5"

          # --- Logging ---
          - "--log.level=INFO"
          - "--log.format=common"

          # --- Access Logs ---
          - "--accesslog=false"
          - "--accesslog.format=json"
          - "--accesslog.filters.statuscodes=400-499,500-599"

          # --- Misc ---
          - "--global.checknewversion=false"
          - "--global.sendanonymoususage=false"

        ports:
          - target: 80
            published: 80
            protocol: tcp
            mode: host
          - target: 443
            published: 443
            protocol: tcp
            mode: host
          - target: 8883
            published: 8883
            protocol: tcp
            mode: host
        environment:
          TZ: "America/Chicago"
          ACME_EMAIL: "admin@example.com"
          CF_DNS_API_TOKEN_FILE: "/run/secrets/cf_dns_api_token"
          TLS_DOMAIN_MAIN: "example.com"
          TLS_DOMAIN_SANS: "*.example.com,*.lab.example.com"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock:ro
          - "$_config:/etc/traefik:ro"
          - "$_data:/letsencrypt"
        networks:
          - proxy
        secrets:
          - source: cf_dns_api_token
            target: cf_dns_api_token
        deploy:
          replicas: 1
          placement:
            constraints: [node.role == manager]
          restart_policy:
            condition: on-failure
            delay: 5s
            max_attempts: 3
            window: 120s
          update_config:
            parallelism: 1
            delay: 10s
            order: start-first
            failure_action: rollback

    networks:
      proxy:
        external: true
        driver: overlay
        attachable: true

    secrets:
      cf_dns_api_token:
        value: "SuperSecretAPIToken"
