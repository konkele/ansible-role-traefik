# -------------------------------------------------------------------
# Generic layered dictionary merge helper for Ansible
#
# Purpose:
#   Merge defaults, optional overrides, and canonical variable
#   into a single final variable.
#
# Merge Order (lowest â†’ highest precedence):
#   1. <var>_defaults    (role defaults / safe baseline)
#   2. <var>             (group_vars / host_vars)
#   3. <var>_override    (explicit playbook or ad-hoc overrides)
# -------------------------------------------------------------------

- name: Verify merge_var_specs is defined
  fail:
    msg: "You must define 'merge_var_specs' as a non-empty list"
  when: merge_var_specs is not defined or merge_var_specs | length == 0

- name: Merge dictionary layers for each variable
  ansible.builtin.set_fact:
    "{{ item.name }}_merged": >-
      {{
        (lookup('vars', item.name + '_defaults') | default({}))
        | combine(
            lookup('vars', item.name) | default({}),
            recursive=True,
            list_merge=item.list_merge | default('append_rp')
          )
        | combine(
            lookup('vars', item.name + '_override') | default({}),
            recursive=True,
            list_merge=item.override_list_merge | default('replace')
          )
      }}
  loop: "{{ merge_var_specs }}"

- name: Promote merged dictionaries to canonical variables
  ansible.builtin.set_fact:
    "{{ item.name }}": "{{ lookup('vars', item.name + '_merged') }}"
  loop: "{{ merge_var_specs }}"
