# -------------------------------------------------------------------
# Generic Layered Dictionary Merge Helper for Ansible
#
# Purpose:
#   Merge defaults, optional overrides, and canonical variable
#   into a single final variable.
#
# Merge Order (lowest â†’ highest precedence):
#   1. <var>_defaults    (role defaults / safe baseline)
#   2. <var>             (group_vars / host_vars)
#   3. <var>_override    (explicit playbook or ad-hoc overrides)
# -------------------------------------------------------------------

- name: Verify merge_var_specs is defined
  fail:
    msg: "You must define 'merge_var_specs' as a non-empty list"
  when: merge_var_specs is not defined or merge_var_specs | length == 0

- name: Merge layers for each variable
  ansible.builtin.set_fact:
    "{{ item.name }}_merged": >-
      {%- set base = lookup('vars', item.name) | default({}) -%}
      {%- set defaults = lookup('vars', item.name + '_defaults') | default({}) -%}
      {%- set override = lookup('vars', item.name + '_override') | default({}) -%}

      {# --- Handle dict-of-dicts or list-of-dicts --- #}
      {%- if base is mapping -%}
        {# Merge as single dictionary #}
        {{
          defaults
          | combine(base, recursive=True, list_merge=item.list_merge | default('append_rp'))
          | combine(override, recursive=True, list_merge=item.override_list_merge | default('replace'))
        }}
      {%- elif base is sequence and base | length > 0 and base[0] is mapping -%}
        {# Merge each item in a list-of-dicts individually if they have 'name' key #}
        {{
          base
          | map(
              'combine',
              defaults,
              recursive=True,
              list_merge=item.list_merge | default('append_rp')
            )
          | map(
              'combine',
              override,
              recursive=True,
              list_merge=item.override_list_merge | default('replace')
            )
          | list
        }}
      {%- else -%}
        {{ base }}
      {%- endif -%}
  loop: "{{ merge_var_specs }}"

- name: Promote merged dictionaries to canonical variables
  ansible.builtin.set_fact:
    "{{ item.name }}": "{{ (lookup('vars', item.name + '_merged') | from_yaml if lookup('vars', item.name + '_merged') is string else lookup('vars', item.name + '_merged')) }}"
  loop: "{{ merge_var_specs }}"
