# -----------------------------------------------------------------------------
# Traefik Role Main Task File
# -----------------------------------------------------------------------------
#
# Purpose:
#   Orchestrate Traefik deployment:
#     1. Load traefik docker_stacks_default from file
#     2. Merge configuration layers (defaults < group < host)
#     3. Normalize directories
#     4. Merge role-specific variables
#     5. Include Traefik stack tasks
#
# -----------------------------------------------------------------------------

# ---------------------------------------------------------------------------
# Load traefik docker_stacks_defaults vars/traefik.yml
# ---------------------------------------------------------------------------
- name: Load Traefik role variables
  ansible.builtin.include_vars:
    file: "vars/traefik.yml"

# ---------------------------------------------------------------------------
# Merge docker stacks (defaults < group < host)
# ---------------------------------------------------------------------------
- name: Merge docker stacks into lookup dictionary with precedence
  ansible.builtin.set_fact:
    docker_stacks_map: >-
      {{
        dict(
          (
            docker_stacks_defaults | default([]) +
            docker_stacks | default([]) +
            docker_stacks_override | default([])
          )
          | sort(attribute='name')
          | groupby('name')
          | map('last')
          | map('last')
          | map(attribute='name')
          | zip(
              (
                docker_stacks_defaults | default([]) +
                docker_stacks | default([]) +
                docker_stacks_override | default([])
              )
              | sort(attribute='name')
              | groupby('name')
              | map('last')
              | map('last')
            )
        )
      }}

# -----------------------------------------------------------------------------
# Normalize stack directories (base, stack, config, data, secrets)
# -----------------------------------------------------------------------------
- name: Normalize directories for each stack
  ansible.builtin.set_fact:
    docker_stacks_map: "{{ docker_stacks_map | combine({ stack_item.key: normalized_stack }, recursive=True) }}"
  loop: "{{ docker_stacks_map | dict2items }}"
  loop_control:
    loop_var: stack_item
    label: "{{ stack_item.key }}"
  vars:
    normalized_stack: >-
      {{
        stack_item.value
        | combine({
            'directories': (
              stack_item.value.directories | default({})
              | combine({
                  'base': { 'path': stack_item.value.directories.base.path | default('/opt/stacks') },
                  'stack': { 'path': stack_item.value.directories.stack.path | default((stack_item.value.directories.base.path | default('/opt/stacks')) ~ '/' ~ stack_item.value.name) },
                  'config': { 'path': stack_item.value.directories.config.path | default((stack_item.value.directories.base.path | default('/opt/stacks')) ~ '/config') }
                },
                recursive=True
              )
            )
          },
          recursive=True
        )
      }}

# ---------------------------------------------------------------------------
# Apply optional Traefik-specific config directory override
# ---------------------------------------------------------------------------
- name: Override Traefik config directory if traefik_config_path is set
  ansible.builtin.set_fact:
    docker_stacks_map: >-
      {{
        docker_stacks_map | combine({
          'traefik': docker_stacks_map['traefik'] | combine({
            'directories': {
              'config': {
                'path': traefik_config_path
              }
            }
          }, recursive=True)
        }, recursive=True)
      }}
  when: traefik_config_path is defined

# ---------------------------------------------------------------------------
# Fail early if Traefik stack is missing
# ---------------------------------------------------------------------------
- name: Fail if 'traefik' stack is not defined
  ansible.builtin.fail:
    msg: "No stack with name 'traefik' was found in merged docker_stacks"
  when: "'traefik' not in docker_stacks_map"

# -----------------------------------------------------------------------------
# Extract Traefik stack into variable
# -----------------------------------------------------------------------------
- name: Set Traefik stack variable
  ansible.builtin.set_fact:
    traefik_stack: "{{ docker_stacks_map['traefik'] }}"

# ---------------------------------------------------------------------------
# Merge role-specific variables
# ---------------------------------------------------------------------------
- name: Merge variables
  import_tasks: merge.yml
  vars:
    merge_var_specs:
      - name: traefik

# ---------------------------------------------------------------------------
# Include Traefik stack tasks
# ---------------------------------------------------------------------------
- name: Include traefik stack tasks
  include_tasks: traefik_stack.yml
  vars:
    stack_input: "{{ traefik_stack }}"