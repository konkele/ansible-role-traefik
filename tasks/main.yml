# -----------------------------------------------------------------------------
# Purpose:
#   Orchestrate Traefik configuration using the docker_stacks data model.
## -----------------------------------------------------------------------------

# -------------------------------------------------------------------
# Merge variables (defaults < inventory < override)
# -------------------------------------------------------------------
- name: Merge variables
  import_tasks: merge.yml
  vars:
    merge_var_specs:
      - name: traefik
      - name: docker_stacks

# -------------------------------------------------------------------
# Normalize variables and paths
# -------------------------------------------------------------------
- name: Prepare variables
  import_tasks: prepare.yml

# -------------------------------------------------------------------
# Ensure required directories exist
# -------------------------------------------------------------------
- name: Create Traefik config directory (and parents)
  ansible.builtin.file:
    path: "{{ docker_stacks.traefik.directories.config.path }}"
    state: directory
    owner: "{{ docker_stacks.traefik.directories.config.owner }}"
    group: "{{ docker_stacks.traefik.directories.config.group }}"
    mode: "{{ docker_stacks.traefik.directories.config.mode }}"
  when: docker_stacks.traefik.state | default('present') == 'present'

# -------------------------------------------------------------------
# Render dynamic configuration
# -------------------------------------------------------------------
- name: Render Traefik dynamic configs
  template:
    src: "dynamic/{{ item }}.yml.j2"
    dest: "{{ docker_stacks.traefik.directories.config.path }}/{{ item }}.yml"
    mode: '0644'
  loop:
    - http
    - tcp
    - udp
    - tls
  when: docker_stacks.traefik.state | default('present') == 'present'
