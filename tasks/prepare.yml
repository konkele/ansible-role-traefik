# -------------------------------------------------------------------
# Purpose:
#   Prepare Traefik-specific filesystem paths and normalize dynamic
#   HTTP router configuration prior to rendering templates.
# -------------------------------------------------------------------

# -------------------------------------------------------------------
# Ensure Traefik state
# -------------------------------------------------------------------
- name: Ensure traefik state is defined
  ansible.builtin.set_fact:
    docker_stacks: >-
      {{
        docker_stacks | combine({
          'traefik': docker_stacks.traefik | combine({
            'state': docker_stacks.traefik.state | default('present')
          }, recursive=True)
        }, recursive=True)
      }}

# -------------------------------------------------------------------
# Normalize directory defaults
# -------------------------------------------------------------------
- name: Cache Traefik directory defaults
  ansible.builtin.set_fact:
    _traefik_dir_defaults: "{{ docker_stacks_defaults.traefik.directories_defaults | default({}) }}"

- name: Normalize Traefik directory defaults
  ansible.builtin.set_fact:
    _traefik_dir_defaults:
      owner: "{{ _traefik_dir_defaults.owner | default('root') }}"
      group: "{{ _traefik_dir_defaults.group | default('docker') }}"
      mode:  "{{ _traefik_dir_defaults.mode  | default('0755') }}"

# -------------------------------------------------------------------
# Normalize Traefik directory structure
# -------------------------------------------------------------------
- name: Normalize Traefik directories
  ansible.builtin.set_fact:
    docker_stacks: >-
      {{
        docker_stacks | combine({
          'traefik': docker_stacks.traefik | combine({
            'directories': {

              'base': {
                'path': docker_stacks.traefik.directories.base.path
                        | default('/opt/stacks'),
                'owner': docker_stacks.traefik.directories.base.owner
                          | default(_traefik_dir_defaults.owner),
                'group': docker_stacks.traefik.directories.base.group
                          | default(_traefik_dir_defaults.group),
                'mode': docker_stacks.traefik.directories.base.mode
                          | default(_traefik_dir_defaults.mode)
              },

              'stack': {
                'path': docker_stacks.traefik.directories.stack.path
                        | default(
                            (docker_stacks.traefik.directories.base.path | default('/opt/stacks'))
                            ~ '/traefik'
                          ),
                'owner': docker_stacks.traefik.directories.stack.owner
                          | default(_traefik_dir_defaults.owner),
                'group': docker_stacks.traefik.directories.stack.group
                          | default(_traefik_dir_defaults.group),
                'mode': docker_stacks.traefik.directories.stack.mode
                          | default(_traefik_dir_defaults.mode)
              },

              'config': {
                'path': docker_stacks.traefik.directories.config.path
                        | default(
                            (
                              docker_stacks.traefik.directories.stack.path
                              | default(
                                  (docker_stacks.traefik.directories.base.path | default('/opt/stacks'))
                                  ~ '/traefik'
                                )
                            ) ~ '/config'
                          ),
                'owner': docker_stacks.traefik.directories.config.owner
                          | default(_traefik_dir_defaults.owner),
                'group': docker_stacks.traefik.directories.config.group
                          | default(_traefik_dir_defaults.group),
                'mode': docker_stacks.traefik.directories.config.mode
                          | default(_traefik_dir_defaults.mode)
              }

            }
          }, recursive=True)
        }, recursive=True)
      }}

# -------------------------------------------------------------------
# Normalize dynamic HTTP routers
# -------------------------------------------------------------------
- name: Ensure traefik.dynamic.http.routers exists
  ansible.builtin.set_fact:
    traefik: >-
      {{
        traefik | default({}) | combine(
          {
            'dynamic': {
              'http': {
                'routers': {}
              }
            }
          },
          recursive=True
        )
      }}

- name: Normalize Traefik HTTP routers
  ansible.builtin.set_fact:
    _normalized_http_routers: >-
      {%- set out = {} -%}
      {%- for name, r in traefik.dynamic.http.routers.items() -%}
        {%- if r.enabled | default(false) | bool -%}
          {# --- normalize host(s) into list --- #}
          {%- set hosts = (
                r.host is iterable and r.host is not string
                and r.host
                or [r.host]
              )
              | reject('equalto', None)
              | map('string')
              | list
          -%}
          {# --- build OR Host() rule --- #}
          {%- set rule = r.rule
                | default(hosts | map('regex_replace', '^(.*)$', 'Host(`\\1`)') | join(' || '))
          -%}
          {# --- build normalized router --- #}
          {%- set normalized = r | combine({
                'hosts': hosts,
                'rule': rule,
                'tls': r.tls | default(false) | bool
            }, recursive=True)
          -%}
          {# --- remove legacy host key --- #}
          {%- set normalized = normalized | dict2items
                | rejectattr('key', 'equalto', 'host')
                | items2dict
          -%}
          {%- set _ = out.update({ name: normalized }) -%}
        {%- else -%}
          {%- set _ = out.update({ name: r }) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}

# # -------------------------------------------------
# # Debug normalized HTTP routers
# # -------------------------------------------------
# - name: Debug normalized HTTP routers
#   ansible.builtin.debug:
#     var: _normalized_http_routers
#   run_once: true
# # -------------------------------------------------
# # Stop play after debug
# # -------------------------------------------------
# - name: Stop play after HTTP router debug
#   ansible.builtin.fail:
#     msg: "Stopping play after debugging normalized HTTP routers."
#   run_once: true

- name: Merge normalized HTTP routers into traefik
  ansible.builtin.set_fact:
    traefik: >-
      {{
        traefik
        | combine(
            {
              'dynamic': {
                'http': {
                  'routers': _normalized_http_routers
                }
              }
            },
            recursive=True
          )
      }}
