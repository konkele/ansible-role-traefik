# -------------------------------------------------------------------
# Purpose:
#   Prepare Traefik-specific filesystem paths and normalize dynamic
#   HTTP router configuration prior to rendering templates.
# -------------------------------------------------------------------

- name: Ensure docker_stack.state is defined
  ansible.builtin.set_fact:
    docker_stack: >-
      {{
        docker_stack
        | combine(
            {'state': docker_stack.state | default('present')},
            recursive=True
          )
      }}

# -------------------------------------------------
# Compute stack + config paths
# -------------------------------------------------

- name: Compute Traefik stack path
  ansible.builtin.set_fact:
    _traefik_stack_path: >-
      {{
        traefik.stack_path
        | default('/opt/stacks/traefik')
      }}

- name: Compute Traefik config path
  ansible.builtin.set_fact:
    _traefik_config_path: "{{ _traefik_stack_path ~ '/config' }}"

- name: Merge Traefik directories
  ansible.builtin.set_fact:
    docker_stack: >-
      {{
        docker_stack | combine(
          {
            'directories': {
              'stack': {
                'path': _traefik_stack_path
              },
              'config': {
                'path': _traefik_config_path,
                'owner': 'root',
                'group': 'docker',
                'mode': '0755'
              }
            }
          },
          recursive=True
        )
      }}

- name: Ensure traefik.dynamic.http.routers exists
  ansible.builtin.set_fact:
    traefik: >-
      {{
        traefik | default({}) | combine(
          {
            'dynamic': {
              'http': {
                'routers': {}
              }
            }
          },
          recursive=True
        )
      }}

- name: Normalize Traefik HTTP routers
  ansible.builtin.set_fact:
    _normalized_http_routers: >-
      {%- set out = {} -%}
      {%- for name, r in traefik.dynamic.http.routers.items() -%}
        {%- if r.enabled | default(false) | bool -%}
          {# --- normalize host(s) into list --- #}
          {%- set hosts = (
                r.host is iterable and r.host is not string
                and r.host
                or [r.host]
              )
              | reject('equalto', None)
              | map('string')
              | list
          -%}
          {# --- build OR Host() rule --- #}
          {%- set rule = r.rule
                | default(hosts | map('regex_replace', '^(.*)$', 'Host(`\\1`)') | join(' || '))
          -%}
          {# --- build normalized router --- #}
          {%- set normalized = r | combine({
                'hosts': hosts,
                'rule': rule,
                'tls': r.tls | default(false) | bool
            }, recursive=True)
          -%}
          {# --- remove legacy host key --- #}
          {%- set normalized = normalized | dict2items
                | rejectattr('key', 'equalto', 'host')
                | items2dict
          -%}
          {%- set _ = out.update({ name: normalized }) -%}
        {%- else -%}
          {%- set _ = out.update({ name: r }) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}

# # -------------------------------------------------
# # Debug normalized HTTP routers
# # -------------------------------------------------
# - name: Debug normalized HTTP routers
#   ansible.builtin.debug:
#     var: _normalized_http_routers
#   run_once: true
# # -------------------------------------------------
# # Stop play after debug
# # -------------------------------------------------
# - name: Stop play after HTTP router debug
#   ansible.builtin.fail:
#     msg: "Stopping play after debugging normalized HTTP routers."
#   run_once: true

- name: Merge normalized HTTP routers into traefik
  ansible.builtin.set_fact:
    traefik: >-
      {{
        traefik
        | combine(
            {
              'dynamic': {
                'http': {
                  'routers': _normalized_http_routers
                }
              }
            },
            recursive=True
          )
      }}
