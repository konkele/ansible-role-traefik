{# Collect HTTP routers #}
{%- set routers = traefik.dynamic.http.routers | default({}) -%}

{# Enabled routers only #}
{%- set enabled = {} -%}
{%- for name, r in routers.items() -%}
  {%- if r.enabled | default(false) | bool -%}
    {%- set _ = enabled.update({ name: r }) -%}
  {%- endif -%}
{%- endfor -%}

{# Routers requiring basic auth #}
{%- set auth_routers = {} -%}
{%- for name, r in enabled.items() -%}
  {%- if r.basic_auth_users is defined and r.basic_auth_users | length > 0 -%}
    {%- set _ = auth_routers.update({ name: r }) -%}
  {%- endif -%}
{%- endfor -%}

http:
{% if enabled %}
  routers:
{% for name, r in enabled.items() %}
    {{ name }}:
      rule: >
        Host(
        {%- if r.host is string -%}
          `{{ r.host }}`
        {%- else -%}
          {{ r.host | map('regex_replace', '^(.*)$', '`\\1`') | join(',') }}
        {%- endif -%}
        )
      entryPoints:
{{ r.entryPoints | default(['websecure']) | to_nice_yaml(indent=2) | indent(8, true) }}
      service: {{ r.service }}
{% if r.tls | default(false) %}
      tls:
        certResolver: letsencrypt
{% endif %}
{% if r.middlewares is defined or name in auth_routers %}
      middlewares:
{% for mw in r.middlewares | default([]) | unique %}
        - {{ mw }}
{% endfor %}
{% if name in auth_routers %}
        - {{ name }}-auth
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{% if traefik.dynamic.http.services is defined %}
  services:
{% for name, svc in traefik.dynamic.http.services.items() %}
    {{ name }}:
{{ svc | to_nice_yaml(indent=2) | indent(6, true) }}
{% endfor %}
{% endif %}

{% if traefik.dynamic.middlewares or auth_routers %}
  middlewares:
{% for name, mw in (traefik.dynamic.middlewares | default({})).items() %}
    {{ name }}:
{{ mw | to_nice_yaml(indent=2) | indent(6, true) }}
{% endfor %}
{% for name, r in auth_routers.items() %}
    {{ name }}-auth:
      basicAuth:
        users:
{% for user in r.basic_auth_users %}
          - "{{ user }}"
{% endfor %}
{% endfor %}
{% endif %}
