traefik_defaults:
  # --------------------------------------------------------------------------
  # DYNAMIC CONFIG (hot-reloadable)
  # --------------------------------------------------------------------------
  dynamic:
    # Middlewares (reusable across routers)
    middlewares:
      security-headers:
        headers:
          sslRedirect: true
          stsSeconds: 31536000
          stsIncludeSubdomains: true
          stsPreload: true
          frameDeny: true
          contentTypeNosniff: true
          browserXssFilter: true

      internal-only:
        ipAllowList:
          sourceRange:
            - 127.0.0.1/32
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16

    # TLS Options
    tls:
      options:
        default:
          minVersion: VersionTLS13
          sniStrict: true

    # HTTP Routers & Services
    http:
      routers:
        dashboard:
          enabled: true
          host: "traefik.example.com"
          service: api@internal
          entryPoints:
            - websecure
          middlewares:
            - security-headers
            - internal-only
          basic_auth_users: []

        whoami:
          enabled: false
          host: "whoami.example.com"
          service: whoami
          entryPoints:
            - websecure
          middlewares:
            - security-headers
            - internal-only
          basic_auth_users:
            - "admin:$apr1$example$hashedpassword"

      services:
        whoami:
          loadBalancer:
            servers:
              - url: "http://127.0.0.1:8080"

    # TCP Routers & Services
    tcp:
      routers:
        mqtt:
          enabled: false
          entryPoints: [mqttsecure]
          rule: "HostSNI(`mqtt.example.com`)"
          service: mqtt
          tls:
            passthrough: true

      services:
        mqtt:
          loadBalancer:
            servers:
              - address: "mqtt.internal.example.com:8883"

    # UDP Routers & Services
    udp:
      routers:
        dns:
          enabled: false
          entryPoints: [dns]
          service: dns

      services:
        dns:
          loadBalancer:
            servers:
              - address: "10.0.0.2:53"

docker_stacks_defaults:
  traefik:
    state: present
    directories:
      base:
        path: /opt/stacks
      stack: {}
      config: {}

    directories_defaults:
      owner: root
      group: docker
      mode: "0755"
